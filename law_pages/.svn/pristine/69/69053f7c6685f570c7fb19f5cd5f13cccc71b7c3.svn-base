angular.module('sbAdminApp').controller('AIOCourtSetp4Ctrl', function (PoliceConfig,PoliceService,AdminConstant,$location,$scope, $stateParams, $state, $http, $log, AlgorithmConfig, AlgorithmService, DictionaryConfig, toaster, $filter,IdentityService) {
    //下一步
    $scope.nextStep = function () {
        console.log($scope.lawCase, "!!!!!!!!!");
        // $scope.calculateTotalLoss()
        $state.go("home_page.prejudge_new.AIOCourtSetp5")
    }

    $scope.calculateTotalLoss = function () {
        $scope.applyTotal = 0
        $scope.lawCase.feeDetail.forEach((v) =>{
          if(v.id == '19'){//处理事故人员误工费
            v.personArray.forEach((m) =>{
                $scope.applyTotal += parseFloat(m.applyAmount || 0)
            })
          } else if (v.id == '09'){//护理费
            v.nursingArray.forEach((m) =>{
                $scope.applyTotal += parseFloat(m.applyAmount || 0)
            })
          } else if (v.id == '14'){//被扶养人生活费
            if (v.dependents.apply){
              if (v.dependents.apply.length == 1) {//单个抚养人
                $scope.dependent = v.dependents.apply[0]
                $scope.standardFee = $scope.lawCase.compensateStandard[dependent.household].expense
                //抚养年限x上一年度城镇居民人均年消费性支出额或者农村居民人均年生活消费支出额/共同抚养人数×伤残系数
                dependent.applyAmount = parseFloat(dependent.fyAge || 0) * parseFloat(standardFee || 0) / parseFloat(dependent.count || 0) * (parseFloat($scope.lawCase.compensateRate) / 100)
                $scope.applyTotal += dependent.applyAmount
              } else {//多个被扶养人
                // a、计算每个抚养人还需要多少年的抚养时间
                // b、确定每个人的每年的抚养费（上一年度城镇居民人均年消费性支出额或者农村居民人均年生活消费支出额 / 共同抚养人数）
                // c、将所有人的抚养费相加与当地标准比较：判断结果是否大于上一年度人居生活消费支出，结果小于支出数额的按照实际数额，结果大于支出数额的按照标准支出。
                // d、依次计算各抚养时间段内人员的抚养费，年数 * 费用。依次循环，直至无抚养人需要负担。
                // e、最终将多个结果相加为总费用 * 伤残系数。
                
                v.dependents.apply.sort(function (a, b) {//根据抚养年限排序，由大到小
                  return a.fyAge - b.fyAge;
                });
                $scope.countFee = 0
                $scope.dependentStandard = $scope.lawCase.compensateStandard[$scope.lawCase.household].expense
                v.dependents.apply.forEach((m, i, arr) =>{
                    $scope.tmpFee = 0;
                    $scope.preYear = 0;
                  if (i != 0) {
                    preYear = arr[i - 1].fyAge;
                  }
                  arr.forEach((j) =>{
                    tmpFee += (dependentStandard * $scope.lawCase.compensateRate / 100 / j.count);
                  })
                  //取标准和计算值中小的
                  tmpFee = Math.min(tmpFee, dependentStandard);
                  countFee += (tmpFee * (m.fyAge - preYear));
                  m.applyAmount = countFee
                })
                $scope.applyTotal += parseFloat(countFee)
              }
            }
          } else {//其他类型的费用
            $scope.applyTotal += parseFloat(v.applyAmount||0)
          }
        })
        $scope.lawCase.applyTotal = $scope.applyTotal.toFixed(2)
        $scope.lawCase.applyTotal = $scope.applyTotal.toFixed(2)
    }
    //上一步
	$scope.preveStep = function () {
		$state.go("home_page.prejudge_new.AIOCourtSetp3")
	}
});