'use strict';

angular.module('sbAdminApp').controller('highMeterCtrl', function($sce,$scope,$log,LawConfig,$timeout,$http,$stateParams,$modalInstance,$modal,DictionaryConfig,toaster,Upload,$state,$rootScope,LoginService) {
	var   num = 0;
    var phi = 0;
	var camidx = 0; 
	var uuid = "";
	var filepath = "";
	var filelist = "";

	$scope.cameraorder=$stateParams.cameraorderid;
	$scope.idtype=$stateParams.idtype;
	
	//alert("cameralorder:"+$scope.cameraorder+"===idType.id:"+$scope.idtype);
	$scope.rotate = function () {
	  // 图片旋转
	    num==4?num=1:num+=1;
	    var browser=navigator.appName ,
	        b_version=navigator.appVersion ,
	        version=b_version.split(";");
	    if(browser=="Microsoft Internet Explorer" ){ 
	    // alert("IE 8.0"); 
	        var img = document.getElementById("highMeterBigImg");
	        // alert(num);
	        img.style.filter="progid:DXImageTransform.Microsoft.BasicImage(rotation="+num+");";
	    }else { 
	         imgtransform();
	    }

	}
	// 动画
	function imgtransform(){
	  var img = document.getElementById("highMeterBigImg");
	      img.style.transform="rotate("+num*90+"deg)";
	      img.style.webkitTransform = "rotate("+num*90+"deg)";
	      img.style.mozTransform = "rotate("+num*90+"deg)";
	      img.style.msTransform = "rotate("+num*90+"deg)";
	      img.style.oTransform = "rotate("+num*90+"deg)";
	      phi=num*90;
	}
	
	
	// 关闭
	$scope.closeTheWindow = function(){
		$modalInstance.close({tesd:4}); 
		//$modalInstance.dismiss('cancel');
	};
	//预览图片
    function openwindow(param) {  
	alert(param+"===============");
	        var modalInstance = $modal.open({  
	        	template :"<div style='z-index:99;width:100%;height:auto;text-align:center;background-color:rgba(0,0,0,0.5)'><img  style='width:99%;height:auto;' src='"+param+"'/></div>"  
	        }); 
	        alert(param+"===============2");
	 }
	
	//拍摄照片
	$scope.takecareof=function(){
		//alert($stateParams.imageAddress+"====");
		var cutpage ='cutpage';  
		var params = "{\"filepath\":\"base64\",\"rotate\":\"" + phi.toString() + "\",\"camidx\":\"" + camidx.toString() + "\",\"cutpage\":\"" + (cutpage[0].checked ? "1" : "0") + "\"}";//
		
		var url = "http://127.0.0.1:38088/video=grabimage";  	

		$.ajax({  
			type: "post",  
			url: url,  
			dataType: "json", 
			data: params,
			success: function(data)
			{			
				var src="data:image/jpg;base64," + data.photoBase64;
				var cars="<dl class='cont_img_list_box_e'>";
				   cars=cars+"<dd>";
				   cars=cars+"<img id='snapshot' src='"+src+"'>";
				   cars=cars+"<div class='cont_img_list_box_e_btn'>";
				   cars=cars+"<span class='left_btn'>删除 </span>";
				   cars=cars+"<span>&nbsp; | &nbsp; </span>";	
				   cars=cars+"<span class='right_btn' > 查看</span>";
				   cars=cars+"</div>";
				   cars=cars+"</dd>";	
				   cars=cars+"<dt>xxxxx</dt>";
				   cars=cars+"</dl>";
				   
					document.getElementById("result").innerHTML = "";
					
					var cutpage ='cutpage';  
					var params = "{\"filepath\":\"\",\"rotate\":\"" + phi.toString() + "\",\"camidx\":\"" + camidx.toString() + "\",\"cutpage\":\"" + (cutpage[0].checked ? "1" : "0") + "\"}";//
					var url = "http://127.0.0.1:38088/video=grabimage";  	
				 
					$.ajax({  
						type: "post",  
						url: url,  
						dataType: "json", 
						data: params,
						success: function(dataimg)
						{				
							if(dataimg.code != 0)
							{
								document.getElementById("result").innerHTML = "GrabImage 失败<br />返回代码 = " + dataimg.code + "<br />  返回信息 = " + dataimg.message; 	
							
							}else{
								AppendLink(dataimg.filepath, 0);
								//$(".cont_img_list_box_c").html("");
								$(".cont_img_list_box_c").prepend(cars);
							cars="";
							//删除图片
						
							$(".left_btn").click(function(){
										$(this).parent().parent().parent().remove();
										var takecarenum=$(".cont_img_list_box_c").children().size();
										$(".cont_img_list_box_bt_text").text("已拍摄("+takecarenum+")");
									});
							
							var takecarenum=$(".cont_img_list_box_c").children().size();
								$(".cont_img_list_box_bt_text").text("已拍摄("+takecarenum+")");
							}
							
							//图片预览查看
							 $(".right_btn").unbind();
							$(".right_btn").click(function(){
							var srcd=$(this).parent().parent().children("img").attr("src");
							alert(srcd);
							openwindow(srcd);
							});
						}
					}); 		   
				   
			}  
			});  
	}
	
	
	

	
	
	
	//图片上传
$scope.uploadbase64img=function(){

    var blob = dataURItoBlob(); // 上一步中的函数
    var canvas = document.createElement('canvas');
    var dataURL = canvas.toDataURL('image/jpeg', 0.5);
     //通过FormData序列化blob
    var fd = new FormData();
    fd.append("file", blob, 'image.jpg');

    
    $.ajax({
    	url: '/lawProject/common/base64UpLoad',
    	method: 'POST',
    	processData: false, // 必须
    	contentType: false, // 必须
    	dataType: 'json',
    	data: fd,
    	success(data) {
    
    		//alert($scope.co.step);
    		//$state.go("dashboard.mediation",{inmagename:data.result,cameraorder:$scope.cameraorder,idtype:$scope.idtype});
    		//$state.go("dashboard.mediation.step12",{inmagename:data.result,cameraorder:$scope.cameraorder,idtype:$scope.idtype});
    		$modalInstance.close({imgurl:data.result}); 
    	}
    	});
    

}; 
    
//获取高拍图片Base64
function toBase64(){
    //#target是目标图标,我们需要将其转换为base64格式
    var c=document.createElement("canvas");
    //设置canvas宽高为图片宽高
    c.width=$('#snapshot').width;
    c.height=$('#snapshot').width;
    //将图片绘制到canvas
    var cxt=c.getContext("2d");
    var img=new Image();
    img.src=$('#snapshot').attr('src');
    var imgsrc=$('#snapshot');
   
    if($('#snapshot').attr('src')==undefined){
    	 alert("请先拍照！");
    	 return;
    	
    }
    cxt.drawImage(img,0,0);
    //得到图片的base64编码数据
    var dd=img.src;
    //log出图片base64数据
    return dd;
}

//Base64转Blob
function dataURItoBlob() {
	var byteString;
	var base64Data= toBase64();
	if (base64Data.split(',')[0].indexOf('base64') >= 0)
	byteString = atob(base64Data.split(',')[1]);
	else
	byteString = unescape(base64Data.split(',')[1]);
	var mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
	var ia = new Uint8Array(byteString.length);
	for (var i = 0; i < byteString.length; i++) {
	ia[i] = byteString.charCodeAt(i);
	}
	return new Blob([ia], {type:mimeString});
	}



  //生成本地图片
  function AppendLink(filePath, type) {
	var div = document.getElementById("fileLink");
	var linkTmp = document.createElement("a");
	linkTmp.href = "file:\/\/\/" + filePath.toString();
	if(type == 0)
		linkTmp.innerText = "图像 "; 
	else
		linkTmp.innerText = "PDF "; 
	linkTmp.target = "_blank"
	div.appendChild(linkTmp);
}	


});