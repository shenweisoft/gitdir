'use strict';
/**
 * @ngdoc function
 * @name sbAdminApp.controller:FilingListCtrl
 * @description
 * # MainCtrl
 * Controller of the sbAdminApp
 */
var app = angular.module('sbAdminApp');
app.filter('stringDate', function() {
  return function(dt) {
    if(typeof (dt) == "string")
    {
      dt = dt.replace(/\-/gi,"\/");
      dt = Date.parse(dt);
    }
    return dt && dt;
  }
});
angular.module('sbAdminApp').controller('FilingListCtrl', function($scope, $stateParams, $state, $location, $timeout, $http,toaster, $log,DictionaryConfig,LawService,LawConfig, LoginService,$rootScope) {

  //查询立案集合Service
  $scope.lawService = LawService;
  //状态字典信息
  $scope.state = DictionaryConfig.lawState;
  //定义状态常量
  $scope.STATE_CONSTANT = {
    "adjustResult":"0",
    "litigationType":"0",//司法类型
    "judicialType":"1", //诉讼类型
    "all":"-1",//全部
    "adjustType":"2"//调解立案
  };
  
  //创建对象构造器
  function FilingSearchVO(){
    this.state = "";
    this.searchArea = "";
    this.lawOrgId = "";
    this.adjustResult = "";
    this.type = "-1";
    //每页条数
    this.pageSize = DictionaryConfig.pageNum;
    //当前页数 默认为第一页
    this.pageNo = 1;
    //总共页数 默认一页
    this.totalPage = 1;
  }
  //初始化对象
  $scope.filingSearchVO = new FilingSearchVO();
  //后台查询数据
  function initData(){


    $scope.userDepart = LoginService.user.sysUser.userDepartList[LoginService.user.sysUser.currentOrg];
    $scope.sysUser = LoginService.user.sysUser;

    //赋予组织权限
    $scope.filingSearchVO.lawOrgId = $scope.userDepart.orgId;
    //待审批/待立案/待分案根据url进行判断
    var url = $location.url();
    if(url.indexOf("approval") > 0){//待审批
      $scope.filingSearchVO.state = DictionaryConfig.lawState.prosecutionFinishState;
      //请求司法确认
      $scope.filingSearchVO.adjustResult = $scope.STATE_CONSTANT.adjustResult;
    }else if(url.indexOf("filing") > 0){//待立案
      $scope.filingSearchVO.state = DictionaryConfig.lawState.approvalState;
    }else if(url.indexOf("division") > 0){//待分案
      $scope.filingSearchVO.state = DictionaryConfig.lawState.filingState;
    }else if(url.indexOf("schedule") > 0){//待排期
        $scope.filingSearchVO.state = DictionaryConfig.lawState.scheduleState;
        $scope.filingSearchVO.type = "1";
    }
    
    var param = angular.copy($scope.filingSearchVO);
    param.searchArea = DictionaryConfig.filterWidthReg(param.searchArea)
    //查询数据
    $scope.lawService.queryFilingList(param).success(function(result) {
      //请求成功
      if (result.code == LawConfig.commonConstant.SUCCESS) {
        $scope.caseList = result.result;
        $log.info($scope.caseList);
      }else{
        $rootScope.toaster(level.error, title.error, $scope.CONSTANT.messageNetError);
      }
    });
    //查询总条数
    $scope.lawService.queryFilingCount(param).success(function(result) {
      if (result.code == LawConfig.commonConstant.SUCCESS) {
        $scope.filingSearchVO.totalPage =  result.result;
      }else{
        $rootScope.toaster(level.error, title.error, $scope.CONSTANT.messageNetError);
      }
    })
  }
  //查询组织
  $scope.initPage = function () {
    //根据组织机构获取人员列表
    $scope.$on('user2Child', function(){
      initData();
    });
    if (LoginService.user.userPermissions) {
      initData();
    }
  };
  //开始调用数据
  $scope.initPage();

  //点击当前页面，展示数据
  $scope.pageChanged = function () {
    $scope.initPage();
  };

  //搜索数据
  $scope.searchData = function(){
    $scope.initPage();
  };
  
  //切换类型
  $scope.selectType = function(val){
    $scope.filingSearchVO.type = val;
    //调用
    $scope.initPage();
  };

  //查询详细
  $scope.queryDetail = function(filing){
    $state.go("dashboard.filing_detail",{serialNo:filing.serialNo,id:filing.id});
  }


  $scope.printData = function(){

     // $state.go("dashboard.policeDistinguish");
      LawService.printData({}).success(function(result) {
        //请求成功
        if (result.code == LawConfig.commonConstant.SUCCESS) {

        }else{
          $rootScope.toaster(level.error, title.error, $scope.CONSTANT.messageNetError);
        }
    });

  }


});
