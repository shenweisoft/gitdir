angular.module('sbAdminApp').controller('openMessageBoardCtrl', function ($scope, $modalInstance, items, $rootScope, LoginService, LoginConfig, AdjustConfig) {

    $scope.queryRedisListBySerialNo = LoginService.queryRedisListBySerialNoService;
    $scope.codeFilePath = AdjustConfig.adjustConStant.codeFileUrl;

    $scope.items = items;

    var socket =  io.connect('http://192.168.223.109:9098');

    //初始化
    $scope.initPage = function () {
        //初始化组织
        //根据组织机构获取人员列表
        $scope.$on('user2Child', function(){
            initData();
        });
        if (LoginService.user.userPermissions) {
            initData();
        }
    };

    function MessageInfo(){
      //用户id
      this.personId = "";
      //姓名
      this.personName = "";
      //日期
      this.createDate = "";
      //信息
      this.content = "";
    }


    $scope.messageInfo = new MessageInfo;

    //$scope.messageList = [{userId:168,userName:"Jerry",createDate:$scope.currentdate,message:"这个案件有问题，把材料补充完成。"},{userId:167,userName:"John",createDate:$scope.currentdate,message:"好的"}];

    console.info($scope.messageList);
    $scope.submitMessage = function () {

        //验证内容
        if(!$scope.message) {
            $scope.messageError = true;
            $rootScope.toaster('warn', '友情提示：', '请输入留言内容！');
            return;
        } else $scope.messageError = undefined;

        $scope.messageInfo.personId = $scope.sysUser.id;
        $scope.messageInfo.personName = $scope.sysUser.text;
        // $scope.messageInfo.createDate = $scope.currentdate;
        $scope.messageInfo.content = $scope.message;
        $scope.messageInfo.serialNo = $scope.items.serialNo;
        if($scope.sysUser.head){
            $scope.messageInfo.headPortrait = $scope.sysUser.head;
        }
        //点击发送信息
        socket.emit('chat_info', JSON.stringify($scope.messageInfo));

        $scope.message = "";
    };

    socket.on('chat_info', function(data){
        var dataJson = JSON.parse(data);
        if(dataJson.serialNo == $scope.items.serialNo){
            $scope.$apply(function(){
                $scope.messageList.push(dataJson);
            })
        }
    });

    //点击关闭modal
    $scope.closeModal = function () {
      $modalInstance.dismiss('cancel');
    }

    //初始化数据
    function initData(){
        //查询用户以及部门
        $scope.userDepart = LoginService.user.sysUser.userDepartList[LoginService.user.sysUser.currentOrg];
        $scope.sysUser = LoginService.user.sysUser;

        $scope.queryRedisListBySerialNo({
            serialNo:$scope.items.serialNo
        }).success(function (result) {
            if (result.code == LoginConfig.commonConStant.SUCCESS) {
                $scope.messageList = result.result;
            }
        });
    }

    //初始化数据
    $scope.initPage();



});
